<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>dwarf-evaluator playground</title>
<style>
html {
    font-family: Calibri, sans-serif;
    box-sizing: border-box;
}
*, *:before, *:after { box-sizing: inherit; }
h1, h2, h3, h4 {
    margin: 0;
}
h2 {
    display: flex;
    margin-top: 1em;
}
h2::before,
h2::after {
    flex: 1 1 auto;
    margin: auto;
    height: 1px;
    border-top: 2px solid black;
    content: '';
}
h2::before {
    margin-right: 2%;
}
h2::after {
    margin-left: 2%;
}
h3 {
    margin-top: 0.5em;
}
.center {
    margin-left: auto;
    margin-right: auto;
    padding: 1% 5%;
    max-width: 45rem;
}
textarea,
.textarea {
    margin: 0;
    padding: 5px;
    border: 1px solid gray;
    border-radius: 3px;
    overflow: auto;
}
textarea {
    width: 100%;
    resize: vertical;
}
input[type="range"] {
    width: 100%;
}
button {
    padding: 1em;
    width: 100%;
    font-weight: bold;
}
#presets_heading,
#presets {
    display: inline;
}
#presets_heading::after {
    content: ': ';
    color: black;
}
#presets { padding: 0; }
#presets > li {
    display: inline-block;
    margin-left: 0.5em;
}
#presets > li::before {
    content: 'â€¢ ';
    color: black;
}
details {
    margin-bottom: 1em;
}
#output {
    font-family: monospace;
}
.trace_step {
    display: block;
    margin-bottom: 1em;
}
.trace_step_op::before { content: 'stack after '; }
.trace_step_op::after { content: ':'; }
.trace_step_stack::after {
    content: 'bottom';
    display: block;
    text-align: center;
}
.trace_step_stack > .stack_element {
    display: block;
    border-bottom: 1px solid black;
    margin-top: 2px;
    margin-left: 2%;
}
.stack_element,
.composite_part {
    padding: 1px;
}
.stack_element_kind::before { content: 'kind='; }
.value::before { content: 'value='; }
.location_offset::before { content: 'offset='; }
.location_storage::before { content: 'storage='; }
.storage_kind::before { content: 'kind='; }
.composite_parts {
    display: flex;
    flex-wrap: wrap;
    flex-direction: column;
    align-content: space-between;
    align-items: stretch;
}
.composite_part {
    border: 1px solid gray;
    border-bottom: none;
    margin: 0 1em;
}
.composite_part:last-child {
    border-bottom: 1px solid gray;
    margin-bottom: 0.5em;
}
.composite_part_start::before { content: 'start='; }
.composite_part_end::before { content: 'end='; }
.trace_result::before {
    display: block;
    content: 'final result:';
}
.stack_element > *::after,
.composite_part > *::after,
.location > *::after
{
    content: ', ';
}
.composite_part > *:last-child::after,
.stack_element > *:last-child::after,
.location > *:last-child::after
{
    content: '';
}
*::before, *::after {
    color: gray;
    font-weight: bold;
    font-size: 0.9em;
}
footer {
    color: gray;
}
</style>
</head>
<body>
<div class="center">
    <h2>Input</h2>
    <h3>Context</h3>
    <textarea id="context" rows="16"
        autocapitalize="false" autocomplete="false" autocorrect="false"
        autofocus="true" required="true" spellcheck="false" wrap="off"
        maxlength="2000"
        ></textarea>
    <h3>Expression</h3>
    <textarea id="input" rows="16"
        autocapitalize="false" autocomplete="false" autocorrect="false"
        autofocus="true" required="true" spellcheck="false" wrap="off"
        maxlength="2000"
        ></textarea>
    <div><button type="button" id="eval">Evaluate</button></div>
    <h3 id="presets_heading">Presets</h3>
    <ul id="presets"></ul>
    <h2>Output</h2>
    <h3>Preprocessed Input</h3>
    <pre class="textarea" id="preprocessed">
    </pre>
    <h3>Evaluation Trace</h3>
    <div id="output"></div>
    <h2>Notes</h2>
    <h4>Source</h4>
    <p>
    This is generated from the DWARF expression evaluator at
    <a href="https://github.com/intel/dwarf-evaluator/blob/main/dwarf_evaluator.ml">intel/dwarf-evaluator</a>.
    The web playground is implemented by <a href="https://github.com/slinder1">Scott Linder</a>
    using <a href="https://github.com/ocsigen/js_of_ocaml">ocsigen/js_of_ocaml</a>.
    </p>
    <p>
    The set of implemented DWARF operators is the same as the set of constructors
    for <tt>type dwarf_op</tt> in the expression evaluator.
    </p>
    <details>
        <summary>Supported Ops (<tt>type dwarf_op</tt>)</summary>
        <pre>
        SUPPORTED_OPS
        </pre>
    </details>
    <h4>Input Syntax</h4>
    <p>
    The (simplified) input format is one DWARF operation per line, with
    space-delimited parameters. Comments begin with <tt>;</tt> and extend to
    the end of the line.
    </p>
    <p>
    The full expression syntax is just an <tt>sexp</tt> list as described at
    <a href="https://github.com/janestreet/sexplib">janestreet/sexplib</a>.
    A preprocessor implements the simplified format and generates the canonical
    <tt>sexp</tt> form. If any non-comment parenthesis character (either
    "<tt>(</tt>" or "<tt>)</tt>") is present the preprocessor is disabled.
    </p>
    <hr>
    <footer>
    <p>Built from <code>GIT_REVISION</code> at <code>CURRENT_TIME</code></p>
    </footer>
</div>
</body>
<script defer>
    let context = document.getElementById('context');
    let input = document.getElementById('input');
    let evalButton = document.getElementById('eval');
    evalButton.addEventListener('click', (ev) => {
        let url = new URL(window.location.href);
        url.searchParams.set('context', context.value);
        url.searchParams.set('input', input.value);
        window.history.replaceState({}, '', url);
    });
    let removeEmptyLines = (s) => {
        return s
            .split('\n')
            .filter(l => l !== '')
            .join('\n');
    };
    let originalUrl = new URL(window.location.href);
    let presets = document.getElementById('presets');
    let addPreset = (shortname, description, ctx, inp) => {
        let a = document.createElement('a');
        a.innerHTML = shortname;
        a.title = description;
        let url = new URL(originalUrl);
        url.searchParams.set('context', removeEmptyLines(ctx));
        url.searchParams.set('input', removeEmptyLines(inp));
        a.href = url;
        let li = document.createElement('li');
        li.appendChild(a);
        presets.appendChild(li);
    };
    addPreset('Clear', 'Reset to empty context and input', '', '');
    addPreset(
    'Maths',
    'Some value-based arithmetic',
    '()',
    `
DW_OP_const4s 40
DW_OP_lit2
DW_OP_plus
    `);
    addPreset(
    'Pointer',
    'Dereference memory and form implicit value via pointer found in register',
    `
(
  (TargetMem 0 "abcdefghijklmnop")
  (TargetReg 0 "\\004\\000\\000\\000")
)`,
    `
DW_OP_reg0
DW_OP_deref
DW_OP_deref
DW_OP_stack_value
    `);
    addPreset(
    'Overlay',
    'Example using DW_OP_overlay',
    `
(
  (TargetMem 0 "abcdefghijklmnop")
  (TargetReg 0 "CAFE")
  (TargetReg 1 "ASDF")
)`,
    `
DW_OP_lit0 ; base
DW_OP_reg0 ; overlay
DW_OP_lit2 ; overlay offset
DW_OP_lit4 ; overlay size
DW_OP_overlay
; base is now the composite on top of the stack
DW_OP_reg1 ; overlay
DW_OP_lit8 ; overlay offset
DW_OP_lit4 ; overlay size
DW_OP_overlay
    `);
    addPreset(
    'Call',
    'Example using DW_OP_call',
    `
(
  (TargetReg 0 "12345678")
  (DW_AT_location xyz
    (
      DW_OP_reg0
      DW_OP_swap
      DW_OP_offset
    )
  )
)`,
    `
DW_OP_lit3
DW_OP_lit2
DW_OP_plus
DW_OP_call xyz
    `);
</script>
<script defer src="dwarf_evaluator_js.bc.js"></script>
</html>
